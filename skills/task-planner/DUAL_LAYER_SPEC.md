# 双层任务架构规范

> **版本**: 2.0.0
> **最后更新**: 2025-12-23
> **相关 Skill**: task-planner

---

## 概述

双层任务架构将任务管理分为两个层次:
- **Layer 1**: `tasks.md` - 粗粒度功能清单 (OpenSpec 标准)
- **Layer 2**: `detailed-tasks.yaml` - 细粒度可执行任务 (AI 执行依据)

```
tasks.md (Human-readable)     detailed-tasks.yaml (AI-executable)
┌────────────────────────┐    ┌─────────────────────────────────┐
│ - [ ] 1.1 Add OTP      │ ─▶ │ - id: TASK-001                  │
│ - [ ] 1.2 Create logs  │    │   parent: "1.1"                 │
│ - [x] 2.1 Login flow   │ ◀─ │   status: completed             │
└────────────────────────┘    └─────────────────────────────────┘
      Forward Sync (A.2)            Backward Sync (B.2)
```

---

## 路径 A: 解析 tasks.md (OpenSpec 双层架构)

### tasks.md 输入格式

```markdown
## 1. Database Setup
- [ ] 1.1 Add OTP secret column to users table
- [ ] 1.2 Create OTP verification logs table

## 2. Backend Implementation
- [ ] 2.1 Add OTP generation endpoint
- [ ] 2.2 Modify login flow to require OTP
```

### 解析流程

```yaml
步骤 1: 解析 OpenSpec tasks.md
  - 扫描章节标题 (## N. Phase Name)
  - 提取 checklist items: - [ ] X.Y Description
  - 提取 parent (X.Y) 和 title
  - 验证编号格式: ^\d+\.\d+$

步骤 2: 转换为原子任务
  - 每个 parent 项对应 1-N 个 TASK-{NNN}
  - 基于任务复杂度决定拆分粒度
  - XL 任务拆分为多个子任务 (共享 parent)

步骤 3: 生成 detailed-tasks.yaml
  - 必需字段: id, parent, title, status, complexity, deliverables
  - 可选字段: dependencies, agent, verification, notes
  - 默认状态: status: pending

步骤 4: 分析依赖关系
  - 基于 parent 顺序: 1.x → 2.x → 3.x
  - 同 parent 内的任务可并行
  - 显式依赖: 基于 deliverables 推断

步骤 5: Agent 分配 (A.3)
  - 基于 deliverables 路径匹配
  - 添加 assignment reason
  - 设置 verification criteria

步骤 6: 写入 detailed-tasks.yaml
  - 位置: {spec_path}/detailed-tasks.yaml
  - 格式: 严格遵循本规范
  - 包含 metadata 和 tasks 数组

输出:
  - 保持原始 tasks.md 不变 (OpenSpec 兼容)
  - 生成 detailed-tasks.yaml (执行依据)
  - 建立 parent → TASK-{NNN} 映射
```

---

## 路径 B: 从 proposal.md 分解 (传统模式)

```yaml
使用场景:
  - Level 1/2 Spec (无 tasks.md)
  - tasks.md 格式错误时的回退

解析内容:
  - ## What 章节: 功能概述
  - ### Key Deliverables: 交付物列表
  - ## Success Criteria 章节: 验收标准

输出:
  - detailed-tasks.yaml (无 parent 字段)
  - 提示: "建议使用 Level 3 Spec 以获得 tasks.md"
```

---

## detailed-tasks.yaml 格式规范

### 完整格式示例

```yaml
# Generated by task-planner v2.0.0
# Dual-Layer Architecture: tasks.md (coarse) + detailed-tasks.yaml (fine)

metadata:
  feature: user-authentication
  created: 2025-12-20T10:00:00+08:00
  updated: 2025-12-20T10:00:00+08:00
  spec: standards/openspec/changes/user-authentication/proposal.md
  datasource: "tasks.md"  # 或 "proposal.md"
  total_tasks: 7
  estimated_hours: 22-34

tasks:
  - id: TASK-001
    parent: "1.1"  # 链接到 tasks.md 编号
    title: Add OTP secret column to users table
    status: pending  # pending | in_progress | completed | blocked
    complexity: M  # S | M | L | XL
    estimated_hours: "2-4"
    dependencies: []
    deliverables:
      - backend/migrations/add_otp_secret.sql
      - backend/src/models/user.py
    agent: backend-architect
    reason: "Database schema design expertise"
    verification:
      - "Migration runs successfully"
      - "Column exists with correct type"
    notes: ""

  - id: TASK-002
    parent: "1.2"
    title: Create OTP generation endpoint
    status: pending
    complexity: L
    estimated_hours: "4-8"
    dependencies: [TASK-001]
    deliverables:
      - backend/src/services/otp_service.py
      - backend/src/routes/otp.py
    agent: backend-architect
    reason: "API design and security expertise"
    verification:
      - "Endpoint returns valid OTP"
      - "Unit tests pass with >85% coverage"
```

### 字段说明

| 字段 | 必需 | 类型 | 说明 |
|------|------|------|------|
| `id` | ✅ | string | 唯一标识: TASK-{NNN} |
| `parent` | ⚠️ | string | tasks.md 编号 (路径 A 必需) |
| `title` | ✅ | string | 任务标题 |
| `status` | ✅ | enum | pending / in_progress / completed / blocked |
| `complexity` | ✅ | enum | S / M / L / XL |
| `estimated_hours` | ✅ | string | 工时范围 (如 "2-4") |
| `dependencies` | ✅ | array | 依赖的 TASK-ID 列表 |
| `deliverables` | ✅ | array | 交付物文件路径列表 |
| `agent` | ⚠️ | string | 分配的 Agent 类型 (A.3 阶段) |
| `reason` | ⚠️ | string | Agent 分配理由 (A.3 阶段) |
| `verification` | ⚠️ | array | 验收标准列表 (A.3 阶段) |
| `notes` | ❌ | string | 备注信息 |

### parent 字段规则

- **格式**: 字符串, 匹配 `^\d+\.\d+$` (如 "1.1", "2.3")
- **来源**: tasks.md 中的 checklist 编号
- **作用**: 关联粗粒度和细粒度任务视图
- **一对多**: 多个 TASK-{NNN} 可共享同一 parent (复杂任务分解)

---

## 同步机制

### 正向同步 (A.2 → detailed-tasks.yaml)

```yaml
触发: task-planner Skill 执行

流程:
  1. 解析 tasks.md 提取所有带编号的 checkbox 项
  2. 生成 detailed-tasks.yaml，parent 字段链接 tasks.md
  3. 按顺序分配 TASK-{NNN} ID
  4. 添加复杂度、依赖、Agent 分配

映射示例:
  tasks.md                      detailed-tasks.yaml
  ─────────────────────────────────────────────────
  - [ ] 1.1 Task A      →      - id: TASK-001
                                 parent: "1.1"

  - [ ] 1.2 Task B      →      - id: TASK-002
                                 parent: "1.2"
```

### 反向同步 (B.2 → tasks.md)

```yaml
触发: progress-updater Skill 执行

流程:
  1. 当 TASK-{NNN} 状态变为 completed
  2. 查找对应的 parent 编号 (如 "1.1")
  3. 更新 tasks.md 的 checkbox: - [ ] → - [x]
  4. 保持其他内容不变

示例:
  # detailed-tasks.yaml
  - id: TASK-001
    parent: "1.1"
    status: completed        # 从 pending 变为 completed

  # tasks.md (更新前)
  - [ ] 1.1 Update phase-a-spec-planning.md

  # tasks.md (更新后)
  - [x] 1.1 Update phase-a-spec-planning.md
```

---

## 编号不可变约束

### 规则

一旦 tasks.md 编号确立，**禁止修改**。

### 原因

- detailed-tasks.yaml 的 parent 字段引用 tasks.md 编号
- 修改编号会破坏 parent 引用关系
- 进度同步将失败或产生错误结果

### 添加新任务 (正确做法)

```markdown
## 1. Architecture Documentation Update
- [x] 1.1 Update phase-a-spec-planning.md
- [x] 1.2 Define responsibilities
- [ ] 1.3 Add examples (NEW)           # 在末尾添加新编号
```

### 删除任务 (正确做法)

```markdown
## 1. Architecture Documentation Update
- [x] 1.1 Update phase-a-spec-planning.md
- [ ] 1.2 Define responsibilities (CANCELLED)   # 保留编号，标记取消
- [ ] 1.3 Add examples
```

---

## 冲突检测与处理

### 检测场景

tasks.md 被手动编辑，导致与 detailed-tasks.yaml 不匹配

### 检测方式

```yaml
warning: Parent reference mismatch
  - TASK-001.parent: "1.1"
  - tasks.md "1.1": "Different task title"
  - Expected: "Update phase-a-spec-planning.md"
```

### 处理策略

| 场景 | 标题相似度 | 处理方式 |
|------|-----------|----------|
| 小修改 | > 80% | 自动修复，记录警告 |
| 大改动 | < 80% | 中止同步，报告冲突 |
| 强制 | - | 使用 `--force` 重新生成 |

---

## 依赖图表示

```
╔═══════════════════════════════════════════════════════════════╗
║                     DEPENDENCY GRAPH                          ║
╚═══════════════════════════════════════════════════════════════╝

    ┌─────────┐
    │ TASK-001│ (数据模型设计)
    └────┬────┘
         │
    ┌────▼────┐     ┌─────────┐
    │ TASK-002│────▶│ TASK-004│ (集成测试)
    │ (API)   │     └─────────┘
    └────┬────┘          ▲
         │               │
    ┌────▼────┐     ┌────┴────┐
    │ TASK-003│────▶│ TASK-005│ (文档)
    │ (测试)  │     └─────────┘
    └─────────┘

Legend:
  ──▶ : 依赖关系 (A ──▶ B: B 依赖 A)
  │   : 顺序执行
```

---

## 相关文档

- [task-planner SKILL.md](./SKILL.md)
- [Agent 分配规则](./AGENT_MAPPING.md)
- [Phase A: 规范与规划](../../../standards/core/ten-step-cycle/phase-a-spec-planning.md)
