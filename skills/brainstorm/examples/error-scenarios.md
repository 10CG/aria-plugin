# 错误处理场景

> **所属文件**: SKILL.md 错误处理章节

---

## 场景 1: 对话无法收敛

```yaml
error: cannot_converge
检测条件:
  - 达到最大轮次 (round >= max_rounds)
  - 共识度 < 0.5
  - 可行方案 > 1 个

处理步骤:
  1. 展示当前状态:
     "我们讨论了 {N} 轮，还有 {M} 个可行方案。"

  2. 提供选项:
     [1] 强制选择当前最优方案
     [2] 降低期望，放宽约束
     [3] 分解问题，分别处理
     [4] 暂停讨论，稍后继续

  3. 如选择强制选择:
     - 选择评分最高的方案
     - 在决策记录中标注 "强制收敛"
     - 说明原因和建议

输出示例:
  ╔═══════════════════════════════════════════════════════════╗
  ║                   对话收敛困难                             ║
  ╠═══════════════════════════════════════════════════════════╣
  ║ 当前状态: 已讨论 8 轮，共识度 45%                          ║
  ╠═══════════════════════════════════════════════════════════╣
  ║ 可行方案对比:                                             ║
  ║ {方案对比表}                                              ║
  ╠═══════════════════════════════════════════════════════════╣
  ║ 建议:                                                      ║
  ║ 1. 如果时间紧，选择 {最优方案}                            ║
  ║ 2. 如果追求完美，建议先做 {MVP} 再迭代                     ║
  ╚═══════════════════════════════════════════════════════════╝
```

---

## 场景 2: 约束冲突

```yaml
error: constraint_conflict
检测条件:
  - 所有方案都违反至少一个硬约束
  - 两个硬约束互相矛盾

处理步骤:
  1. 识别冲突约束:
     "检测到约束冲突:"
     列出冲突的约束及其原因

  2. 解释影响:
     "在当前约束下，没有可行方案"
     说明哪些约束导致哪些方案不可行

  3. 提供选项:
     [1] 放宽约束 {X}
     [2] 降低约束 {Y} 的优先级
     [3] 寻找新的方案
     [4] 分阶段实现，先满足部分约束

输出示例:
  ⚠️ 约束冲突检测

  冲突约束:
  - 约束 A: 预算 < $500/月
  - 约束 B: 使用企业级托管服务

  冲突原因: 企业级托管服务的最低费用为 $800/月

  建议:
  [1] 放宽预算约束到 $1000/月
  [2] 使用开源自建方案代替托管服务
  [3] 混合方案：核心功能托管 + 其他自建
```

---

## 场景 3: 无可行方案

```yaml
error: no_feasible_solution
检测条件:
  - 所有方案都违反硬约束
  - feasible_options == 0

处理步骤:
  1. 说明情况:
     "在当前约束下，没有可行方案"

  2. 展示被排除的方案及原因:
     | 方案 | 排除原因 | 违反约束 |
     |------|----------|----------|
     | A | 成本超预算 | budget: <$500 |
     | B | 需数据出境 | compliance: 数据不出境 |

  3. 提供选项:
     [1] 放宽约束 {约束列表}
     [2] 寻找新的方案
     [3] 分阶段实现，逐步满足约束

  4. 生成新方案建议:
     基于约束，提出简化方案
     建议分阶段实现路径
```

---

## 场景 4: 用户放弃/中断

```yaml
error: user_abort
检测条件:
  - 用户输入: "算了"、"不用了"、"暂停"
  - 用户长时间无响应

处理步骤:
  1. 确认意图:
     "确定要暂停讨论吗？"

  2. 保存当前进度:
     保存已收集的信息
     保存已讨论的方案
     生成 "草稿" 状态的决策记录

  3. 提供恢复选项:
     "当前讨论已保存到 {path}"
     "使用 /brainstorm continue 可继续讨论"

草稿格式:
  ```markdown
  # 头脑风暴草稿 - {标题}

  > 状态: 草稿 | 创建时间: {timestamp} | 位置: {path}

  ## 已收集信息
  - 问题定义: {问题描述}
  - 约束条件: {约束列表}
  - 已讨论方案: {方案列表}

  ## 待讨论
  - {待讨论项1}
  - {待讨论项2}

  ## 恢复方式
  使用 `/brainstorm continue {id}` 继续讨论
  ```
```

---

## 场景 5: 上下文不足

```yaml
error: insufficient_context
检测条件:
  - 无法从用户输入提取关键信息
  - 模糊度 > 0.8 且无法通过澄清降低

处理步骤:
  1. 提供示例:
     "让我给你一个参考示例..."

  2. 分解问题:
     "这个问题比较大，我们可以从某个方面开始"
     提供 2-3 个切入角度

  3. 建议准备:
     "建议先准备以下信息再开始讨论:"
     列出需要准备的内容
```

---

## 场景 6: 第一次使用

```yaml
scenario: first_time_user
检测: docs/decisions/ 目录不存在

动作:
  1. 创建目录
  2. 简化开场白
  3. 提供更多引导

输出:
  "欢迎使用头脑风暴！这是第一次使用，让我简单介绍一下..."
```

---

## 场景 7: 跨模式切换

```yaml
scenario: mode_switch
触发: 用户明确要求切换模式

动作:
  1. 保存当前模式的进度
  2. 生成临时决策记录
  3. 切换到新模式
  4. 加载相关上下文

示例:
  用户: "先讨论技术方案"
  AI: "切换到 technical 模式，基于之前的问题定义..."
```

---

## 场景 8: 决策撤销

```yaml
scenario: decision_reversal
触发: 用户想撤销之前的决策

动作:
  1. 检查决策的可撤销性
  2. 如果可撤销:
     - 标记原决策为 "Superseded"
     - 记录撤销原因
     - 重新讨论
  3. 如果不可撤销:
     - 说明影响
     - 建议新方案
```

---

## 错误处理流程图

```
检测点                    错误类型                   处理动作
────────                  ─────────                  ────────

每轮结束              ┌──────────────┐          保存进度
└─→ 共识度 < 0.5   ──→│ 无法收敛     │─────────→ 提供选项
     轮次接近上限      └──────────────┘          建议方案

约束验证              ┌──────────────┐          识别冲突
└─→ 无可行方案      ──→│ 约束冲突     │─────────→ 放宽约束
     方案全被排除      └──────────────┘          寻找新方案

用户输入              ┌──────────────┐          确认意图
└─→ "算了" / "暂停" ──→│ 用户放弃     │─────────→ 保存草稿
                         └──────────────┘          提供恢复方式

上下文检查            ┌──────────────┐          提供示例
└─→ 信息不足        ──→│ 上下文不足   │─────────→ 分解问题
     模糊度 > 0.8      └──────────────┘          建议准备
```
