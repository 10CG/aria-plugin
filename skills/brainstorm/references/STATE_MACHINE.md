# 对话状态机详解

> **所属文件**: SKILL.md 阶段 2.1
> **状态**: INIT → CLARIFY → EXPLORE → CONVERGE → SUMMARY → COMPLETE

---

## 状态序列

```
用户输入
    │
    ▼
┌─────────┐
│  INIT   │ 模式检测 + 上下文加载 + 开场问题
└────┬────┘
     │ 用户首次响应
     ▼
┌──────────┐
│ CLARIFY  │ 术语澄清 + 概念统一 + 边界界定
└────┬─────┘
     │ 关键术语已定义 >= 3
     ▼
┌──────────┐
│ EXPLORE  │ 方案列举 + 约束收集 + 方案过滤
└────┬─────┘
     │ 可行方案已明确 >= 2
     ▼
┌───────────┐
│ CONVERGE  │ 方案对比 + 风险评估 + 决策引导
└────┬──────┘
     │ 用户明确选择 / 共识度 >= 0.7
     ▼
┌──────────┐
│ SUMMARY  │ 总结要点 + 确认决策 + 生成草稿
└────┬─────┘
     │ 用户确认
     ▼
┌───────────┐
│ COMPLETE  │ 写入日志 + 同步文档 + 后续建议
└───────────┘
```

---

## 状态详解

### INIT - 初始化状态

**职责**: 对话开始时的准备工作

**入口动作**:
1. 分析用户输入，确定模式 (problem/requirements/technical)
2. 从项目配置加载默认约束
3. 扫描现有决策记录
4. 选择对应模式的引导模板
5. 输出开场问题

**退出条件**: 用户首次响应

**下一状态**: CLARIFY

**开场问题示例**:
- problem: "让我们先理解一下你想要解决的问题。能详细描述一下你的想法吗？"
- requirements: "让我们把这个需求分解成可实现的 User Stories。首先，要实现的核心功能是什么？"
- technical: "让我们讨论一下技术实现方案。有哪些技术选项需要考虑？"

---

### CLARIFY - 澄清状态

**职责**: 统一术语，建立共同理解

**入口动作**:
1. 从用户输入中提取可能模糊的术语
2. 识别业务术语、技术术语、缩写
3. 请求定义关键术语

**执行动作**:
- 术语澄清: "你说的 [X] 具体指什么？"
- 概念统一: "所以 [X] 的定义是..."
- 边界界定: "这个需求的边界在哪里？"

**退出条件**:
- 关键术语已定义 >= 3 个
- 或达到最大问题数 (3个)

**下一状态**: EXPLORE

---

### EXPLORE - 探索状态

**职责**: 列举方案，收集约束，过滤不可行选项

**入口动作**:
1. 列举所有可能的方案/选项
2. 收集约束条件
3. 检查约束库

**执行动作**:
- 方案列举: "实现 [X] 有哪些方式？"
- 约束收集: "有什么限制条件？(预算/时间/技术)"
- 约束验证: 对每个方案检查是否违反约束
- 方案过滤: 标记不可行方案

**退出条件**:
- 可行方案已明确 >= 2 个
- 或达到最大问题数 (5个)

**下一状态**: CONVERGE

---

### CONVERGE - 收敛状态

**职责**: 对比方案，引导决策

**入口动作**:
1. 创建方案对比表
2. 评估每个方案的优缺点
3. 计算方案评分 (基于约束匹配度)

**执行动作**:
- 对比分析: "方案 A 和 B 的主要区别是什么？"
- 风险评估: "每个方案的主要风险是什么？"
- 决策引导: "综合考虑，你倾向哪个方案？"

**退出条件**:
- 用户明确选择 ("我选择方案A")
- 或共识度 >= 0.8
- 或达到最大问题数 (3个)

**下一状态**: SUMMARY

---

### SUMMARY - 总结状态

**职责**: 确认决策，生成记录

**入口动作**:
1. 总结讨论要点
2. 列出所有收集的约束
3. 确认最终选择
4. 生成决策记录草稿

**执行动作**:
- 总结确认: "所以我们决定采用...，对吗？"
- 约束回顾: "我们的约束是..."
- 决策确认: "这个决策的理由是..."

**退出条件**: 用户确认总结

**下一状态**: COMPLETE

---

### COMPLETE - 完成状态

**职责**: 保存决策，同步文档

**入口动作**:
1. 写入决策日志 (docs/decisions/)
2. 使用 decision-template.md 生成格式化记录
3. 生成决策 ID (DEC-YYYYMMDD-序号)
4. 更新决策索引

**执行动作**:
- 写入文件: 使用 Write 工具创建决策文档
- 同步文档: 如需要，触发 spec-drafter
- 提供后续建议

**输出**:
- 决策记录路径
- 后续步骤选项

---

## 配置文件

详见 [config/state-machine.yaml](../config/state-machine.md)
