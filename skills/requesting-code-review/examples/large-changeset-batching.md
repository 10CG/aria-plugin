# 大变更集分批检查场景示例

> **场景**: 大型变更集分批进行代码审查
> **策略**: 将大型变更集拆分为多个审查批次，每个批次独立审查
> **Phase 1**: 规范合规性检查 - 分批验证
> **Phase 2**: 代码质量检查 - 分批验证
> **结果**: 提高审查效率和准确性

---

## 场景描述

用户完成重构任务（涉及 15 个文件变更），变更集过大，一次性审查会导致上下文过大和审查质量下降。

---

## 输入参数

```yaml
WHAT_WAS_IMPLEMENTED: 重构用户服务模块，拆分为多个子服务，引入依赖注入
PLAN_OR_REQUIREMENTS: detailed-tasks.yaml TASK-005
BASE_SHA: 1a2b3c4
HEAD_SHA: 9d8e7f6 (跨越 15 个文件)
```

---

## 大变更集问题

### 一次性审查的问题

```
问题 1: 上下文过大
  - 15 个文件的变更
  - 约 3000 行代码变更
  - Agent 上下文可能超出限制
  - 审查质量下降

问题 2: 审查时间过长
  - 审查时间: ~10-15 分钟
  - 用户等待时间过长

问题 3: 问题定位困难
  - 问题分散在大量代码中
  - 难以快速定位关键问题
```

---

## 解决方案: 分批审查

### 批次划分策略

```yaml
批次 1: 核心服务重构 (优先级最高)
  文件: 5 个
  - src/services/user-service-core.ts
  - src/services/auth-service.ts
  - src/services/user-repository.ts
  - src/models/user.model.ts
  - tests/unit/user-service.test.ts

批次 2: 依赖注入框架 (优先级高)
  文件: 4 个
  - src/core/di-container.ts
  - src/core/types.ts
  - src/core/decorators.ts
  - tests/unit/di-container.test.ts

批次 3: 辅助工具和配置 (优先级中)
  文件: 6 个
  - src/utils/logger.ts
  - src/config/app.config.ts
  - src/middleware/cors.ts
  - docs/api/users-api.md
  - .env.example
```

---

## 审查执行流程

### 批次 1 审查

```
┌─────────────────────────────────────────────────────────────┐
│              批次 1: 核心服务重构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: PASS                                           │
│    - 文件路径与计划一致                                  │
│    - 所有功能已实现                                     │
│    - 无范围变更                                          │
│                                                             │
│  Phase 2: PASS                                           │
│    - 优点: 清晰的服务边界                                │
│    - Minor: 单元测试可增加                                  │
│                                                             │
│  结果: ✅ 通过，继续下一批次                              │
└─────────────────────────────────────────────────────────────┘
```

### 批次 2 审查

```
┌─────────────────────────────────────────────────────────────┐
│              批次 2: 依赖注入框架                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: PASS                                           │
│    - 文件路径与计划一致                                  │
│    - 功能全部实现                                        │
│                                                             │
│  Phase 2: PASS_WITH_WARNINGS                               │
│    - Important: 装饰器模式可能导致循环依赖                │
│    - 建议: 添加依赖图文档                                │
│                                                             │
│  结果: ⚠️ 有警告，记录问题后继续                            │
└─────────────────────────────────────────────────────────────┘
```

### 批次 3 审查

```
┌─────────────────────────────────────────────────────────────┐
│              批次 3: 辅助工具和配置                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: PASS                                           │
│    - 文件路径与计划一致                                  │
│    - 所有功能已实现                                        │
│                                                             │
│  Phase 2: PASS                                           │
│    - 优点: 配置结构清晰                                  │
│    - 优点: 日志工具完善                                    │
│                                                             │
│  结果: ✅ 通过，所有批次审查完成                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 分批审查总结

```yaml
分批审查报告:
  总批次数: 3
  总文件数: 15
  总代码行数: ~3000

各批次结果:
  批次 1 (核心服务): ✅ PASS + ✅ PASS
  批次 2 (依赖注入): ✅ PASS + ⚠️ WARN
  批次 3 (辅助工具): ✅ PASS + ✅ PASS

最终评估: 建议
  - 批次 2 的警告 (循环依赖风险) 需要在合并前处理
  - 所有批次 Phase 1 都通过，规范符合性好
  - 代码质量整体良好
```

---

## 工作流示例

```bash
# 1. 获取 SHA
BASE_SHA=$(git rev-parse HEAD~1)
HEAD_SHA=$(git rev-parse HEAD)

# 2. 调用分批审查 (通过 requesting-code-review Skill)
# 系统自动检测到大变更集，建议分批

# 3. 用户确认分批策略

# 4. 依次执行各批次审查
# 每批次使用独立的 git diff 范围

# 5. 汇总所有批次结果
```

---

## 分批策略对比

| 策略 | 优点 | 缺点 |
|------|------|------|
| **一次性审查** | 完整上下文 | 上下文大、质量低 |
| **分批审查** | 上下文可控、效率高 | 需要人工分批 |

---

## 关键要点

### 自动分批触发条件

```yaml
自动分批条件 (在 requesting-code-review Skill 中):
  文件数 > 10: 自动建议分批
  代码行数 > 1000: 自动建议分批
  跨多个模块: 自动按模块分批
```

### 优先级排序原则

```
分批优先级:
  1. 核心业务逻辑 (必须审查)
  2. 基础设施 (重要)
  3. 辅助功能 (可后置)
```

### 批次间依赖

```yaml
批次依赖:
  批次 1 → 批次 2 → 批次 3 (顺序执行)
  理由: 批次 2 依赖批次 1 的服务
```

---

## 最佳实践

### 预防大变更集

```
建议策略:
  1. 拆分为多个小任务
  2. 每个任务独立审查
  3. 累积渐进，避免大爆炸
```

### 审查效率优化

```
效率提升技巧:
  - 使用 git diff --stat 快速预览
  - 按模块分组审查
  - 并行审查无依赖的批次
```

---

**示例版本**: 1.0.0
**创建日期**: 2026-02-06
**维护**: Aria 项目组
