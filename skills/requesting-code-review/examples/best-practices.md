# 两阶段代码审查最佳实践

> **目标**: 确保代码质量，提高开发效率
> **原则**: Review Early, Review Often
> **范围**: 两阶段审查流程、团队协作、工具集成

---

## 核心原则

### 1. Review Early, Review Often

```yaml
理念:
  - 小步快跑，频繁审查
  - 问题早发现，早修复
  - 降低修复成本

实践:
  ✅ 每个任务完成后审查
  ✅ 每个 PR 前审查
  ✅ 合并前最终审查

  ❌ 开发完成后一次性审查
  ❌ 只在 PR 时审查
  ❌ 跳过审查直接合并
```

### 2. 两阶段分离

```yaml
Phase 1: 规范合规性 (阻塞性)
  目标: 验证实现符合计划
  阻塞: FAIL 终止审查

Phase 2: 代码质量 (非阻塞性)
  目标: 检查代码质量
  阻塞: 仅 Critical 阻塞
```

### 3. 仅审查变更

```yaml
原则:
  - 只审查 git diff 范围
  - 不审查已验证的代码
  - 不修改未变更的部分

好处:
  - 审查速度快
  - 聚焦变更内容
  - 减少噪音
```

---

## 审查时机

### 推荐审查时机

```
┌─────────────────────────────────────────────────────────────────┐
│                      开发流程与审查时机                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  开始任务                                                       │
│    │                                                           │
│    ├─→ 编写测试 (TDD)                                           │
│    │                                                           │
│    ├─→ 实现功能                                                │
│    │                                                           │
│    ├─→ 📍 审查时机 1: 任务完成后                               │
│    │   │                                                       │
│    │   └─→ /requesting-code-review                            │
│    │       │                                                   │
│    │       ├─→ Phase 1 PASS?                                  │
│    │       │   ├─→ Yes: 继续 Phase 2                           │
│    │       │   └─→ No: 修复后重新审查                          │
│    │       │                                                   │
│    │       └─→ Phase 2 PASS?                                  │
│    │           ├─→ Critical: 修复后继续                        │
│    │           └─→ Important/Minor: 记录后继续                 │
│    │                                                           │
│    ├─→ 修复问题 (如有)                                         │
│    │                                                           │
│    ├─→ 📍 审查时机 2: PR 前最终审查                           │
│    │   │                                                       │
│    │   └─→ /requesting-code-review                            │
│    │       确认无遗留问题                                      │
│    │                                                           │
│    └─→ 创建 PR / 合并                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 不推荐的审查时机

```yaml
❌ 开发过程中频繁审查
   问题: 打断开发心流

❌ 大爆炸式审查
   问题: 变更过大，审查质量下降

❌ 仅 PR 时审查
   问题: 问题发现太晚，修复成本高
```

---

## 任务规划建议

### 小任务优先

```yaml
推荐:
  - 每个任务 4-8 小时可完成
  - 单个任务变更 < 500 行
  - 每个任务独立审查

不推荐:
  - 大任务 (> 2 天)
  - 单个任务变更 > 1000 行
  - 多任务合并审查
```

### 分批策略

```yaml
当任务过大时:

1. 按模块分批
   批次 1: 核心服务
   批次 2: 辅助工具
   批次 3: 文档更新

2. 按优先级分批
   批次 1: 高优先级功能
   批次 2: 中优先级功能
   批次 3: 低优先级功能

3. 每批独立审查
   - 独立的 git diff
   - 独立的审查报告
   - 独立的修复流程
```

---

## 团队协作

### 审查责任

```yaml
开发者责任:
  - 完成任务后主动请求审查
  - 修复审查发现的问题
  - 理解并接受审查建议

审查者责任:
  - 及时提供审查反馈
  - 给出明确的修复建议
  - 保持友好专业的态度
```

### 审查文化

```yaml
健康文化:
  - 审查是学习机会
  - 对事不对人
  - 持续改进

不健康文化:
  - 审查是惩罚
  - 人身攻击
  - 固执己见
```

### 审查反馈

```yaml
良好反馈:
  ✅ "建议使用 map 替代 forEach，更符合函数式编程风格"
  ✅ "这里可能有 SQL 注入风险，建议使用参数化查询"

不良反馈:
  ❌ "这代码写的什么垃圾"
  ❌ "重写"
```

---

## 问题处理

### Critical 问题处理

```yaml
发现 Critical 问题:
  1. 立即停止
  2. 定位问题位置
  3. 修复问题
  4. 提交修复
  5. 重新审查

修复前:                 修复后:
  [Critical] BUG   →     [Fixed] 修复
  [Other] Issue    →     [Other] Issue
  Cannot continue  →     Can continue
```

### Important 问题处理

```yaml
发现 Important 问题:
  选项 A: 立即修复 (推荐)
  选项 B: 记录后继续
  选项 C: 创建跟踪 Issue

建议:
  - 安全相关: 立即修复
  - 性能相关: 可稍后修复
  - 风险相关: 立即修复
```

### Minor 问题处理

```yaml
发现 Minor 问题:
  - 记录到审查报告
  - 可选择修复
  - 不阻塞继续

常见 Minor:
  - 代码风格微调
  - 注释补充
  - 变量命名建议
```

---

## 工具集成

### Git Hooks 集成

```bash
# .git/hooks/post-commit
#!/bin/bash

echo "📋 建议运行代码审查: /requesting-code-review"
```

### CI/CD 集成

```yaml
# .github/workflows/review.yml
name: Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Review
        run: |
          npx claude-code review \
            --base ${{ github.event.pull_request.base.sha }} \
            --head ${{ github.event.pull_request.head.sha }}

      - name: Comment Results
        uses: actions/github-script@v6
        with:
          script: |
            // Post review as PR comment
```

### IDE 集成

```yaml
VS Code:
  - 安装 Claude Code 扩展
  - 配置快捷键: Ctrl+Shift+R
  - 快速调用审查

JetBrains:
  - 安装 Claude Code 插件
  - 配置快捷键: Cmd+Shift+R
  - 快速调用审查
```

---

## 常见问题

### Q: 审查时间过长怎么办？

```yaml
原因:
  - 变更范围太大
  - 审查深度过深

解决方案:
  - 拆分为小任务
  - 分批审查
  - 调整审查深度
  - 使用增量审查
```

### Q: 审查总是失败怎么办？

```yaml
原因:
  - 代码质量问题
  - 规范理解偏差

解决方案:
  - 检查 CLAUDE.md 规范
  - 参考优秀示例
  - 主动询问审查者
  - 持续改进
```

### Q: 如何平衡速度与质量？

```yaml
平衡策略:
  1. 小任务快速审查
  2. 关键功能深度审查
  3. 非关键功能适度审查

  速度      质量
    ┌────────┐
  快 │   ✓    │ 日常任务
    ├────────┤
  慢 │      ✓ │ 关键功能
    └────────┘
```

---

## 审查检查清单

### Phase 1 检查清单

```yaml
规范合规性:
  [ ] 文件路径与计划一致
  [ ] 所有计划功能已实现
  [ ] 无计划外功能
  [ ] OpenSpec 字段已更新

如有任何一项 ❌:
  → Phase 1 FAIL，修复后重新审查
```

### Phase 2 检查清单

```yaml
代码质量:
  [ ] 代码风格一致
  [ ] 测试覆盖充分
  [ ] 无安全漏洞
  [ ] 架构设计合理
  [ ] 性能可接受
  [ ] 错误处理完善

Critical 问题 → 必须修复
Important 问题 → 建议修复
Minor 问题 → 记录即可
```

---

## 成功指标

```yaml
审查通过率:
  目标: > 80%
  含义: 大部分提交一次性通过

审查时间:
  目标: < 10 分钟/任务
  含义: 审查效率高

修复时间:
  目标: < 30 分钟/问题
  含义: 问题快速修复

问题发现率:
  目标: > 90% 在 Phase 1/2 发现
  含义: 审查有效捕获问题
```

---

## 持续改进

```yaml
定期回顾:
  - 每月审查团队审查流程
  - 收集团队反馈
  - 调整审查标准

优化方向:
  - 提高审查速度
  - 提高审查准确度
  - 减少误报率
  - 改善团队体验

实验:
  - 尝试新的审查策略
  - A/B 测试审查标准
  - 收集数据验证效果
```

---

**示例版本**: 1.0.0
**创建日期**: 2026-02-06
**维护**: Aria 项目组
