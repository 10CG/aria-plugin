# Skill 调用方式示例

> **场景**: 通过 requesting-code-review Skill 请求代码审查
> **入口**: `/requesting-code-review`
> **结果**: 自动填充模板并调用 aria:code-reviewer Agent

---

## 场景描述

用户完成任务 TASK-001（添加用户认证功能），通过 requesting-code-review Skill 请求代码审查。

---

## 调用方式

### 方式 1: 直接调用 Skill

```bash
# 在 Claude Code 中执行
/requesting-code-review
```

### 方式 2: 通过 subagent-driver 自动触发

```yaml
# subagent-driver 配置
enable_two_phase: true  # 启用两阶段审查
```

任务完成后自动触发审查。

---

## 交互流程

### 步骤 1: Skill 收集信息

```
┌─────────────────────────────────────────────────────────────┐
│           requesting-code-review Skill                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 检测 Git 状态                                           │
│     - 检测未提交的变更                                      │
│     - 获取 BASE_SHA 和 HEAD_SHA                            │
│                                                             │
│  2. 收集任务信息                                            │
│     - 读取 WHAT_WAS_IMPLEMENTED                            │
│     - 查找 PLAN_OR_REQUIREMENTS                            │
│                                                             │
│  3. 自动填充模板                                            │
│     - 替换模板中的占位符                                   │
│     - 生成完整的审查请求                                   │
│                                                             │
│  4. 调用 aria:code-reviewer Agent                          │
│     - 启动 Fresh Subagent                                  │
│     - 传递审查请求                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 步骤 2: 用户确认信息

```yaml
Skill 询问:
  question: "请确认任务信息"
  collected_info:
    WHAT_WAS_IMPLEMENTED: "实现了用户登录和注册功能"
    PLAN_OR_REQUIREMENTS: "detailed-tasks.yaml TASK-001"
    BASE_SHA: "a7981ec"
    HEAD_SHA: "3df7661"

用户选项:
  A. 确认并开始审查
  B. 修改信息
  C. 取消
```

### 步骤 3: Agent 执行审查

```
aria:code-reviewer Agent
    │
    ├── Phase 1: 规范合规性检查
    │   ├── 读取 detailed-tasks.yaml
    │   ├── 验证文件路径
    │   ├── 验证功能完整性
    │   └── 判定: PASS / FAIL
    │
    └── Phase 2: 代码质量检查 (如果 Phase 1 PASS)
        ├── 检查代码风格
        ├── 检查测试覆盖
        ├── 检查安全性
        └── 判定: PASS / FAIL_WITH_WARNINGS
```

---

## 完整示例

### 输入

```bash
/requesting-code-review
```

### Skill 输出

```yaml
检测到以下变更:

任务: TASK-001 (添加用户认证功能)
实现描述: 实现了用户登录和注册功能，包括 JWT Token 生成和验证
计划基准: detailed-tasks.yaml TASK-001
Git 范围: a7981ec..3df7661 (3 个文件)

请确认是否继续审查?
```

### Agent 审查结果

```yaml
═════════════════════════════════════════════════════════════════════
                    CODE REVIEW REPORT / 代码审查报告
═════════════════════════════════════════════════════════════════════

Task: TASK-001 (添加用户认证功能)
Base SHA: a7981ec
Head SHA: 3df7661

┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 规范合规性 / Specification Compliance            │
│ Result: ✅ PASS                                            │
├─────────────────────────────────────────────────────────────┤
│ ✓ 文件路径与计划一致                                       │
│ ✓ 所有计划功能已实现                                       │
│ ✓ 无范围变更                                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Phase 2: 代码质量 / Code Quality                          │
│ Result: ✅ PASS                                            │
├─────────────────────────────────────────────────────────────┤
│ Strengths:                                                 │
│   - 清晰的架构设计                                         │
│   - 全面的测试覆盖 (18 个单元测试)                         │
│   - 良好的错误处理                                         │
│                                                             │
│ Issues:                                                    │
│   Minor (1):                                               │
│     - 缺少进度指示器                                       │
│                                                             │
│ Assessment: ✅ 可以继续下一任务                            │
└─────────────────────────────────────────────────────────────┘

═════════════════════════════════════════════════════════════════════
```

---

## 后续选项

审查完成后，用户可以选择：

```yaml
选项:
  [1] 继续下一任务
  [2] 修复发现的问题后重新审查
  [3] 查看详细审查日志
  [4] 导出审查报告

默认选项: [1] (如果无 Critical 或 Important 问题)
```

---

## 参数说明

### WHAT_WAS_IMPLEMENTED

描述实现了什么功能。

```yaml
格式: 自然语言描述
示例: "实现了用户登录和注册功能，包括 JWT Token 生成和验证"
```

### PLAN_OR_REQUIREMENTS

计划基准文件，用于 Phase 1 规范检查。

```yaml
格式: "{文件名} {任务ID}"
示例:
  - "detailed-tasks.yaml TASK-001"
  - "openspec/changes/task-001/proposal.md"
  - 无 (跳过 Phase 1)
```

### BASE_SHA

对比基准提交。

```yaml
获取方式:
  - 自动: HEAD~1 (最新提交的前一个)
  - 手动: git rev-parse <commit>
```

### HEAD_SHA

当前提交。

```yaml
获取方式:
  - 自动: HEAD (当前最新提交)
  - 手动: git rev-parse <commit>
```

---

## 与直接调用 Agent 的区别

| 方面 | Skill 调用 | 直接 Agent 调用 |
|------|-----------|----------------|
| **便利性** | 高 (自动填充) | 中 (手动准备) |
| **灵活性** | 中 (标准化流程) | 高 (完全自定义) |
| **适用场景** | 日常任务审查 | 特殊审查需求 |

---

## 最佳实践

### 1. 何时调用 Skill

```yaml
推荐场景:
  - 任务完成后立即审查
  - 创建 PR 前审查
  - 合并到主分支前审查

不推荐场景:
  - 开发过程中频繁审查
  - 小到只有几行的变更
```

### 2. 审查时机

```yaml
最佳时机: 完成单个任务后
原因:
  - 变更范围可控
  - 问题容易定位
  - 修复成本低
```

### 3. 审查频率

```
推荐: Review Early, Review Often

├── 每个小任务后
├── 每个 PR 前
└── 每次合并前
```

---

## 常见问题

### Q: 审查失败后怎么办？

```yaml
步骤:
  1. 查看审查报告中的具体问题
  2. 修复问题
  3. 提交修复
  4. 重新调用审查
```

### Q: 可以跳过 Phase 1 吗？

```yaml
可以:
  PLAN_OR_REQUIREMENTS: 无

结果:
  - Phase 1 跳过
  - 直接执行 Phase 2
```

### Q: 审查需要多长时间？

```yaml
时间估算:
  - 小任务 (< 100 行变更): ~2-3 分钟
  - 中任务 (100-500 行): ~5-8 分钟
  - 大任务 (> 500 行): ~10-15 分钟

注: 大变更集建议分批审查
```

---

**示例版本**: 1.0.0
**创建日期**: 2026-02-06
**维护**: Aria 项目组
